{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{{ url_for('inicio') }}?user_id={{ user_id }}" class="btn btn-outline-secondary btn-sm">
        ‚Üê Volver al inicio
    </a>
    <h4 class="mb-0">Perfil de {{ usuario.nombre_usuario }}</h4>
    <div></div> <!-- Elemento vac√≠o para alineaci√≥n -->
</div>
<div class="card p-4">
    <!-- Encabezado con foto y nombre -->
    <div class="text-center mb-4">
        {% if usuario.foto %}
            <img src="{{ url_for('static', filename='fotos/' + usuario.foto) }}"
                 class="rounded-circle mb-3" 
                 width="120" height="120" style="object-fit:cover;">
        {% else %}
            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3"
                 style="width:120px;height:120px;font-size:40px;color:#8b4513;">
                {{ usuario.nombre_usuario[0]|upper }}
            </div>
        {% endif %}
        
        <h2>{{ usuario.nombre_usuario }}</h2>
        
        {% if usuario.nombre or usuario.apellidos %}
            <p class="text-muted">{{ usuario.nombre or '' }} {{ usuario.apellidos or '' }}</p>
        {% endif %}
        
        {% if usuario.ubicacion %}
            <p class="text-muted">üìç {{ usuario.ubicacion }}</p>
        {% endif %}
    </div>
    
    <!-- Presentaci√≥n -->
    {% if usuario.presentacion %}
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">üìù Sobre m√≠</h5>
                <p class="card-text">{{ usuario.presentacion }}</p>
            </div>
        </div>
    {% endif %}
    
    <!-- Estad√≠sticas -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">üìä Estad√≠sticas</h5>
            <div class="row text-center">
                <div class="col-6">
                    <h4 class="text-beersp">{{ degustaciones_count }}</h4>
                    <small class="text-muted">Degustaciones</small>
                </div>
                <div class="col-6">
                    <h4 class="text-beersp">{{ usuario.fecha_registro.strftime('%Y') }}</h4>
                    <small class="text-muted">Miembro desde</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- √öltima degustaci√≥n -->
    {% if ultima_degustacion %}
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">üç∫ √öltima degustaci√≥n</h5>
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h6 class="mb-0">{{ ultima_degustacion.cerveza.nombre }}</h6>
                    <small class="text-muted">
                        {{ ultima_degustacion.cerveza.estilo }} ¬∑ 
                        {{ ultima_degustacion.cerveza.pais_procedencia }}
                    </small>
                    {% if ultima_degustacion.puntuacion %}
                    <div class="mt-1">
                        <small>‚≠ê {{ ultima_degustacion.puntuacion }}/5</small>
                    </div>
                    {% endif %}
                </div>
                <div class="flex-shrink-0">
                    <small class="text-muted">{{ ultima_degustacion.fecha.strftime('%d/%m/%Y') }}</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Acciones de amistad -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">üë• Conexi√≥n</h5>
            
            {% if es_amigo %}
                <div class="alert alert-success">
                    ‚úÖ Sois amigos
                </div>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('inicio') }}?user_id={{ user_id }}" class="btn btn-outline-secondary">
                        ‚Üê Volver a mi inicio
                    </a>
                </div>
                
            {% elif solicitud_pendiente %}
                {% if solicitud_pendiente.usuario_id == usuario_actual_id %}
                    <div class="alert alert-warning">
                        ‚è≥ Ya le has enviado una solicitud de amistad
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        üì© Tienes una solicitud pendiente de este usuario
                    </div>
                {% endif %}
                <div class="d-grid gap-2">
                    <a href="{{ url_for('amigos') }}?user_id={{ user_id }}" class="btn btn-beersp">
                        Gestionar solicitudes
                    </a>
                    <a href="{{ url_for('inicio') }}?user_id={{ user_id }}" class="btn btn-outline-secondary">
                        ‚Üê Volver a mi inicio
                    </a>
                </div>
                
            {% else %}
                <!-- No sois amigos, no hay solicitud pendiente -->
                <div class="d-grid gap-2">
                    <button class="btn btn-beersp" id="btnEnviarSolicitud" data-user-id="{{ usuario.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-plus me-1" viewBox="0 0 16 16">
                            <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C9.516 10.68 8.289 10 6 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                            <path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                        Enviar solicitud de amistad
                    </button>
                    <a href="{{ url_for('inicio') }}?user_id={{ user_id }}" class="btn btn-outline-secondary">
                        ‚Üê Volver a mi inicio
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Bot√≥n para enviar solicitud de amistad
    const btnEnviarSolicitud = document.getElementById('btnEnviarSolicitud');
    if (btnEnviarSolicitud) {
        btnEnviarSolicitud.addEventListener('click', function() {
            const usuarioId = this.getAttribute('data-user-id');
            
            fetch('/enviar_solicitud_amistad', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ amigo_id: usuarioId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Solicitud enviada correctamente');
                    // Actualizar la p√°gina para mostrar el nuevo estado
                    location.reload();
                } else {
                    alert('‚ùå ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al enviar la solicitud');
            });
        });
    }
});
</script>

<style>
.text-beersp {
    color: #d4a017;
}
</style>
{% endblock %}