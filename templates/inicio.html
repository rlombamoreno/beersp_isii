{% extends "base.html" %}

{% block content %}
<div class="card p-4">
  <!-- Men√∫ general -->
  <nav class="nav nav-pills nav-fill mb-4">
    <a class="nav-link active" href="{{ url_for('inicio', id=usuario.id) }}">Inicio</a>
    <a class="nav-link" href="{{ url_for('mis_degustaciones', id=usuario.id) }}">Mis Degustaciones</a>
    <a class="nav-link" href="#">Top Degustaciones</a>
    <a class="nav-link" href="{{ url_for('perfil', id=usuario.id) }}">Mi Perfil</a>
    <a class="nav-link" href="{{ url_for('logout') }}">Cerrar sesi√≥n</a>
  </nav>
  <!-- Panel resumen -->
  <div class="mb-4">
    <h5 class="border-bottom pb-2">Mi perfil</h5>
    <div class="d-flex align-items-center mb-3">
      {% if usuario.foto %}
        <img src="{{ url_for('static', filename='fotos/' + usuario.foto) }}"
             class="rounded-circle me-3" width="60" height="60" style="object-fit:cover;">
      {% else %}
        <div class="bg-light rounded-circle me-3 d-flex align-items-center justify-content-center"
             style="width:60px;height:60px;">
          <span class="text-muted">{{ usuario.nombre_usuario[0]|upper }}</span>
        </div>
      {% endif %}
      <div>
        <h6 class="mb-0">{{ usuario.nombre_usuario }}</h6>
        <small class="text-muted">Miembro desde {{ usuario.fecha_registro.strftime('%B %Y') }}</small>
      </div>
    </div>
    <ul class="list-unstyled small">
      <li>‚úÖ {{ stats.degustaciones }} degustaciones</li>
      <li>üìç {{ stats.locales_nuevos }} locales nuevos (√∫ltimos 7 d√≠as)</li>
    </ul>
    {% if stats.solicitudes_amistad > 0 %}
      <div class="alert alert-info p-2 mt-2">
        üì© Tienes <strong>{{ stats.solicitudes_amistad }}</strong> solicitud(es) de amistad pendiente(s).
      </div>
    {% endif %}
  </div>
  <!-- üîç Buscador -->
  <div class="mb-4">
    <h5 class="border-bottom pb-2">üîç Buscar cerveza</h5>
    <div class="input-group mb-3">
      <input type="text" id="buscador" class="form-control"
             placeholder="Nombre o estilo (ej: IPA, stout, belga...)">
      <button class="btn btn-outline-secondary" type="button" id="btnBuscar">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
        </svg>
      </button>
    </div>
    <div id="resultados" class="mt-3">
      <!-- Vac√≠o al inicio -->
    </div>
  </div>
  <!-- ‚úÖ Secci√≥n de favoritas: ahora persistente REALMENTE -->
  <div id="seccionFavoritas" class="mb-4 d-none">
    <h5 class="border-bottom pb-2 d-flex justify-content-between align-items-center">
      Mis cervezas favoritas
      <button class="btn btn-sm btn-outline-secondary d-none" id="btnVerTodasFavoritas">Ver todas</button>
    </h5>
    <ul class="list-unstyled" id="listaFavoritas"></ul>
  </div>
  <!-- Amigos / galardones -->
  {% if amigos_activos %}
  <div class="mb-4">
    <h5 class="border-bottom pb-2">Amigos activos</h5>
    {% for amigo in amigos_activos %}
      <p class="mb-1"><strong>{{ amigo.nombre_usuario }}</strong> degust√≥ <em>{{ amigo.ultima_cerveza }}</em></p>
    {% endfor %}
    <a href="#" class="btn btn-sm btn-outline-secondary">Ver todos</a>
  </div>
  {% endif %}
  {% if galardones %}
  <div>
    <h5 class="border-bottom pb-2">Mis √∫ltimos galardones</h5>
    <div class="d-flex flex-wrap gap-2">
      {% for galardon in galardones %}
        <span class="badge bg-warning text-dark">
          {{ galardon.nombre }} (Nv. {{ galardon.nivel }})
        </span>
      {% endfor %}
    </div>
    <a href="#" class="btn btn-sm btn-outline-secondary mt-2">Ver todos</a>
  </div>
  {% endif %}
</div>

<!-- Modal de Cerveza -->
<div class="modal fade" id="modalCerveza" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Cerveza</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Estilo:</strong> <span id="modalEstilo"></span></p>
        <p><strong>Pa√≠s:</strong> <span id="modalPais"></span></p>
        <p><strong>Alcohol:</strong> <span id="modalABV"></span>% ABV</p>
        <p><strong>IBU (amargor):</strong> <span id="modalIBU"></span></p>
        <p><strong>Color:</strong> <span id="modalColor"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-warning" id="btnFavorita"></button>
        <button type="button" class="btn btn-beersp" id="btnRegistrarDegustacion">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cup-straw me-1" viewBox="0 0 16 16">
            <path d="M4.5 4a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 1 0v-7a.5.5 0 0 0-.5-.5z"/>
            <path d="M11.517 3.156L13.5 4.194v1.388l-1.983 1.038A2.5 2.5 0 0 0 10 7.5v4.793l-1.5-1.5A1.5 1.5 0 0 0 6.379 10H3.5a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .293-.459L7.5 1.022V.5a.5.5 0 0 1 1 0v.522l4.217 2.134a.5.5 0 0 1 .291.459z"/>
          </svg>
          Registrar degustaci√≥n
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Incluir modales de degustaci√≥n -->
{% include 'modal_degustacion.html' %}

<script>
// --- CARGA INICIAL: IDs de favoritas desde el backend ---
const favoritasIds = {{ favoritas_ids | tojson }}; // Recibido del backend
// --- FIN CARGA ---
const cervezasCache = {};
let sugerenciasMostradas = false;

// Funci√≥n para mostrar notificaciones sutiles
function mostrarNotificacion(mensaje, tipo = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger', 
        'info': 'alert-info',
        'warning': 'alert-warning'
    }[tipo] || 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    notification.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-eliminar despu√©s de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// --- SISTEMA DE PA√çSES DESDE API ---

// Funci√≥n para cargar pa√≠ses desde REST Countries API
function cargarPaises() {
    console.log("üåç Cargando pa√≠ses desde API...");
    return fetch('https://restcountries.com/v3.1/all?fields=name,translations')
        .then(response => {
            if (!response.ok) throw new Error('Error al cargar pa√≠ses desde API');
            return response.json();
        })
        .then(data => {
            const paises = data.map(country => 
                country.translations?.spa?.common || country.name.common
            ).sort();
            
            console.log(`‚úÖ ${paises.length} pa√≠ses cargados desde API`);
            return paises;
        })
        .catch(error => {
            console.error('Error cargando pa√≠ses:', error);
            // Fallback b√°sico si la API falla
            mostrarNotificacion('Usando lista local de pa√≠ses', 'info');
            return [
                "Alemania", "B√©lgica", "Espa√±a", "Francia", "Italia", "Pa√≠ses Bajos",
                "Portugal", "Reino Unido", "Estados Unidos", "M√©xico", "Argentina",
                "Brasil", "Chile", "Colombia", "Per√∫", "Austria", "Dinamarca",
                "Noruega", "Suecia", "Suiza", "Rep√∫blica Checa", "Polonia"
            ];
        });
}

// Funci√≥n para llenar selects de pa√≠ses
function llenarSelectPaises(paises) {
    const selectPaisConsumo = document.getElementById('pais_consumicion');
    const selectPaisLocal = document.querySelector('#formNuevoLocal select[name="pais"]');
    
    if (selectPaisConsumo) {
        selectPaisConsumo.innerHTML = '<option value="">Seleccionar pa√≠s...</option>';
        paises.forEach(pais => {
            const option = document.createElement('option');
            option.value = pais;
            option.textContent = pais;
            selectPaisConsumo.appendChild(option);
        });
    }
    
    if (selectPaisLocal) {
        selectPaisLocal.innerHTML = '<option value="">Seleccionar pa√≠s...</option>';
        paises.forEach(pais => {
            const option = document.createElement('option');
            option.value = pais;
            option.textContent = pais;
            selectPaisLocal.appendChild(option);
        });
        
        // Poner Espa√±a por defecto en el formulario de local
        const opcionEspa√±a = Array.from(selectPaisLocal.options).find(opt => opt.value === "Espa√±a");
        if (opcionEspa√±a) {
            selectPaisLocal.value = "Espa√±a";
        }
    }
}

// --- ACTUALIZAR SECCI√ìN FAVORITAS ---
function actualizarSeccionFavoritas() {
  const seccion = document.getElementById('seccionFavoritas');
  const lista = document.getElementById('listaFavoritas');
  const btn = document.getElementById('btnVerTodasFavoritas');

  const disponibles = favoritasIds.filter(id => cervezasCache[id]);
  
  if (disponibles.length === 0) {
    seccion.classList.add('d-none');
    return;
  }
  
  seccion.classList.remove('d-none');
  const paraMostrar = disponibles.slice(0, 3);
  
  // Limpiar lista y elementos adicionales
  lista.innerHTML = '';
  const todasDiv = document.getElementById('favoritasTodas');
  if (todasDiv) {
    todasDiv.remove();
  }

  // Mostrar primeras 3
  paraMostrar.forEach(id => {
    const c = cervezasCache[id];
    const puntuacionStr = c.puntuacion !== undefined && c.puntuacion !== null
      ? ` ‚Äî ‚≠ê ${parseFloat(c.puntuacion).toFixed(1)}`
      : '';
    const li = document.createElement('li');
    li.innerHTML = `${c.nombre} (${c.estilo})${puntuacionStr}`;
    lista.appendChild(li);
  });

  // Manejar bot√≥n "Ver todas"
  if (disponibles.length > 3) {
    btn.classList.remove('d-none');
    
    // Funci√≥n para mostrar/ocultar todas
    btn.onclick = () => {
      const todasDiv = document.getElementById('favoritasTodas');
      if (todasDiv) {
        // Si ya est√° expandido, ocultar
        todasDiv.remove();
        btn.textContent = 'Ver todas';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-outline-secondary');
      } else {
        // Si est√° contra√≠do, expandir
        const nuevasTodasDiv = document.createElement('div');
        nuevasTodasDiv.id = 'favoritasTodas';
        nuevasTodasDiv.classList.add('mt-2');
        
        disponibles.slice(3).forEach(id => {
          const c = cervezasCache[id];
          const puntuacionStr = c.puntuacion !== undefined && c.puntuacion !== null
            ? ` ‚Äî ‚≠ê ${parseFloat(c.puntuacion).toFixed(1)}`
            : '';
          const li = document.createElement('li');
          li.innerHTML = `${c.nombre} (${c.estilo})${puntuacionStr}`;
          nuevasTodasDiv.appendChild(li);
        });
        
        lista.parentNode.appendChild(nuevasTodasDiv);
        btn.textContent = 'Ver menos';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-secondary');
      }
    };
  } else {
    btn.classList.add('d-none');
  }
}
// --- FIN ACTUALIZAR ---

// --- CACHear Cerveza ---
function cachearCerveza(cerveza, puntuacion = null) {
  cervezasCache[cerveza.id] = {
    id: cerveza.id,
    nombre: cerveza.nombre,
    estilo: cerveza.estilo,
    abv: cerveza.porcentaje_alcohol,
    pais: cerveza.pais_procedencia,
    ibu: cerveza.ibu || 'N/A',
    color: cerveza.color,
    puntuacion: puntuacion
  };
}
// --- FIN CACHear ---

// --- RENDERIZAR LISTA ---
function renderizarLista(cervezas) {
  let html = `<div class="list-group">`;
  cervezas.forEach(c => {
    const puntuacion = favoritasIds.includes(c.id)
      ? (cervezasCache[c.id]?.puntuacion || 5.0)
      : null;
    cachearCerveza(c, puntuacion);
    const esFavorita = favoritasIds.includes(c.id);
    const estrella = esFavorita
      ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
      : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg>';
    html += `
      <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
         data-bs-toggle="modal" data-bs-target="#modalCerveza"
         data-id="${c.id}"
         data-nombre="${c.nombre}"
         data-estilo="${c.estilo}"
         data-pais="${c.pais_procedencia}"
         data-abv="${c.porcentaje_alcohol}"
         data-ibu="${c.ibu || 'N/A'}"
         data-color="${c.color}">
        <div>
          <strong>${c.nombre}</strong><br>
          <small class="text-muted">${c.estilo} ¬∑ ${c.pais_procedencia}</small>
        </div>
        <div>
          <span class="badge bg-secondary me-1">${c.porcentaje_alcohol}%</span>
          ${estrella}
        </div>
      </a>
    `;
  });
  html += `</div>`;
  document.getElementById('resultados').innerHTML = html;
}
// --- FIN RENDERIZAR ---

// --- ACTUALIZAR BOTON FAVORITA ---
function actualizarBotonFavorita(id) {
  const btn = document.getElementById('btnFavorita');
  btn.innerHTML = '';
  btn.onclick = null;
  const esFavorita = favoritasIds.includes(id);
  
  const icono = esFavorita
    ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
    : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg>';
  
  btn.innerHTML = `${icono} <span class="ms-1">${esFavorita ? 'En favoritas' : 'Agregar a favoritas'}</span>`;
  
  btn.onclick = function() {
    console.log("Intentando toggle favorita para cerveza ID:", id);
    
    // Agregar token CSRF si est√° disponible
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
    const headers = {
      'Content-Type': 'application/json',
    };
    
    if (csrfToken) {
      headers['X-CSRFToken'] = csrfToken;
    }
    
    fetch('/toggle_favorita', {
      method: 'POST',
      headers: headers,
      credentials: 'include',
      body: JSON.stringify({ cerveza_id: id })
    })
    .then(response => {
      console.log("Respuesta recibida, status:", response.status);
      if (response.status === 401) {
        // Sesi√≥n expirada
        mostrarNotificacion('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.', 'error');
        window.location.href = '/login';
        return Promise.reject('Sesi√≥n expirada');
      }
      if (!response.ok) {
        return response.text().then(text => { 
          throw new Error(`Error ${response.status}: ${text}`); 
        });
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        if (data.action === 'added') {
          // Agregar a favoritas
          if (!favoritasIds.includes(id)) {
            favoritasIds.push(id);
          }
          btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg> <span class="ms-1">En favoritas</span>`;
          
          if (cervezasCache[id]) {
            cervezasCache[id].puntuacion = 5.0;
          }
          mostrarNotificacion('Cerveza a√±adida a favoritas', 'success');
        } else if (data.action === 'removed') {
          // Remover de favoritas
          const index = favoritasIds.indexOf(id);
          if (index > -1) {
            favoritasIds.splice(index, 1);
          }
          btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg> <span class="ms-1">Agregar a favoritas</span>`;
          
          if (cervezasCache[id]) {
            delete cervezasCache[id].puntuacion;
          }
          mostrarNotificacion('Cerveza eliminada de favoritas', 'info');
        }
        
        // Actualizar visualmente en la lista
        actualizarEstrellaEnLista(id, data.action === 'added');
        
        // Actualizar secci√≥n de favoritas
        actualizarSeccionFavoritas();
        
      } else {
        console.error('Error del servidor:', data.message);
        mostrarNotificacion('Error: ' + data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Error de red o en la solicitud:', error);
      if (error !== 'Sesi√≥n expirada') {
        mostrarNotificacion('Hubo un problema al actualizar', 'error');
      }
    });
  };
}

// Funci√≥n auxiliar para actualizar estrella en lista
function actualizarEstrellaEnLista(id, esFavorita) {
  const listaElementos = document.querySelectorAll('#resultados .list-group-item');
  listaElementos.forEach(el => {
    if (parseInt(el.getAttribute('data-id')) === id) {
      const estrellaContainer = el.querySelector('div:last-child');
      if (estrellaContainer) {
        const nuevaEstrella = esFavorita
          ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
          : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg>';
        
        // Reemplazar solo la estrella, mantener el badge
        const badge = estrellaContainer.querySelector('.badge');
        estrellaContainer.innerHTML = badge ? `${badge.outerHTML} ${nuevaEstrella}` : nuevaEstrella;
      }
    }
  });
}

// --- SISTEMA DE DEGUSTACIONES ---

// Cargar locales al abrir modal de degustaci√≥n - VERSI√ìN MEJORADA
function cargarLocales() {
    return fetch('/api/locales')
        .then(res => {
            if (!res.ok) {
                throw new Error(`Error ${res.status} al cargar locales`);
            }
            return res.json();
        })
        .then(data => {
            const select = document.getElementById('local_id');
            if (!select) {
                console.error("No se encontr√≥ el select de locales");
                return;
            }
            
            select.innerHTML = '<option value="">Seleccionar local...</option>';
            data.locales.forEach(local => {
                const option = document.createElement('option');
                option.value = local.id;
                option.textContent = `${local.nombre}${local.ciudad ? ` (${local.ciudad})` : ''}`;
                select.appendChild(option);
            });
            console.log("Locales cargados:", data.locales.length);
        })
        .catch(err => {
            console.error('Error cargando locales:', err);
            mostrarNotificacion('Error al cargar la lista de locales', 'error');
        });
}

// --- CARGA INICIAL ---
document.addEventListener('DOMContentLoaded', () => {
  // Cargar cervezas favoritas desde el backend para la secci√≥n de favoritas
  fetch('/mis_favoritas')
    .then(res => res.json())
    .then(data => {
      data.cervezas.forEach(c => cachearCerveza(c, 5.0)); // Asignar puntuaci√≥n de favorita
      actualizarSeccionFavoritas(); // Mostrar la secci√≥n si hay favoritas
    })
    .catch(err => {
      console.error('Error al cargar favoritas iniciales:', err);
      // Asegurar que la secci√≥n est√© oculta si falla
      document.getElementById('seccionFavoritas').classList.add('d-none');
    });

  const buscador = document.getElementById('buscador');
  const btnBuscar = document.getElementById('btnBuscar');

  buscador.addEventListener('focus', cargarSugerencias);
  buscador.addEventListener('input', () => {
    const q = buscador.value.trim();
    if (q === '') cargarSugerencias();
    else {
      fetch(`/buscar_cervezas?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
          renderizarLista(data.cervezas);
          document.getElementById('resultados').dataset.cervezas = JSON.stringify(data.cervezas);
        });
    }
  });
  btnBuscar.addEventListener('click', () => {
    const q = buscador.value.trim();
    if (q) {
      fetch(`/buscar_cervezas?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
          renderizarLista(data.cervezas);
          document.getElementById('resultados').dataset.cervezas = JSON.stringify(data.cervezas);
        });
    } else buscador.focus();
  });
  buscador.addEventListener('blur', () => setTimeout(ocultarSugerenciasSiVacio, 150));

  const modal = document.getElementById('modalCerveza');
  if (modal) {
    modal.addEventListener('show.bs.modal', function (event) {
      const b = event.relatedTarget;
      const id = parseInt(b.getAttribute('data-id'));
      document.getElementById('modalTitle').textContent = b.getAttribute('data-nombre');
      document.getElementById('modalEstilo').textContent = b.getAttribute('data-estilo');
      document.getElementById('modalPais').textContent = b.getAttribute('data-pais');
      document.getElementById('modalABV').textContent = b.getAttribute('data-abv');
      document.getElementById('modalIBU').textContent = b.getAttribute('data-ibu');
      document.getElementById('modalColor').textContent = b.getAttribute('data-color');
      actualizarBotonFavorita(id);
      
      // Guardar ID de cerveza actual para degustaci√≥n
      this.setAttribute('data-current-cerveza-id', id);
    });
  }

  // Configurar modal de degustaci√≥n
  const modalDegustacion = document.getElementById('modalDegustacion');
  if (modalDegustacion) {
    modalDegustacion.addEventListener('show.bs.modal', function() {
      // Cargar locales y pa√≠ses en paralelo
      cargarLocales();
      cargarPaises().then(paises => {
        llenarSelectPaises(paises);
      });
      
      // Configurar contador de comentario
      const comentario = document.getElementById('comentario');
      const contador = document.getElementById('contadorComentario');
      comentario.addEventListener('input', function() {
        contador.textContent = this.value.length;
      });
    });
  }
  
  // Bot√≥n registrar degustaci√≥n (en modal de cerveza)
  const btnRegistrarDegustacion = document.getElementById('btnRegistrarDegustacion');
  if (btnRegistrarDegustacion) {
    btnRegistrarDegustacion.onclick = function() {
      const modalCerveza = bootstrap.Modal.getInstance(document.getElementById('modalCerveza'));
      const modalDegustacion = new bootstrap.Modal(document.getElementById('modalDegustacion'));
      
      // Pasar datos de la cerveza al modal de degustaci√≥n
      const cervezaId = document.getElementById('modalCerveza').getAttribute('data-current-cerveza-id');
      const cervezaNombre = document.getElementById('modalTitle').textContent;
      const cervezaInfo = `${document.getElementById('modalEstilo').textContent} ¬∑ ${document.getElementById('modalPais').textContent}`;
      
      document.getElementById('degustacion_cerveza_id').value = cervezaId;
      document.getElementById('degustacion_cerveza_nombre').value = cervezaNombre;
      document.getElementById('degustacionCervezaNombre').textContent = cervezaNombre;
      document.getElementById('degustacionCervezaInfo').textContent = cervezaInfo;
      
      modalCerveza.hide();
      modalDegustacion.show();
    };
  }
  
  // Guardar degustaci√≥n
  const btnGuardarDegustacion = document.getElementById('btnGuardarDegustacion');
  if (btnGuardarDegustacion) {
    btnGuardarDegustacion.onclick = function() {
      const formData = new FormData(document.getElementById('formDegustacion'));
      const data = {
        cerveza_id: formData.get('cerveza_id'),
        puntuacion: formData.get('puntuacion'),
        comentario: formData.get('comentario'),
        tama√±o: formData.get('tama√±o'),
        formato: formData.get('formato'),
        local_id: formData.get('local_id') || null,
        pais_consumicion: formData.get('pais_consumicion')
      };
      
      // Validaci√≥n b√°sica
      if (!data.cerveza_id) {
        mostrarNotificacion('Error: No se especific√≥ la cerveza', 'error');
        return;
      }
      
      // Agregar CSRF token si est√° disponible
      const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
      const headers = {
        'Content-Type': 'application/json',
      };
      
      if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
      }
      
      fetch('/api/degustacion/nueva', {
        method: 'POST',
        headers: headers,
        credentials: 'include',
        body: JSON.stringify(data)
      })
      .then(response => {
        if (response.status === 401) {
          mostrarNotificacion('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.', 'error');
          window.location.href = '/login';
          return;
        }
        return response.json();
      })
      .then(result => {
        if (result.success) {
          // ‚úÖ Cerrar modal silenciosamente
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalDegustacion'));
          modal.hide();
          
          // Recargar para actualizar estad√≠sticas
          setTimeout(() => {
            location.reload();
          }, 500);
        } else {
          mostrarNotificacion('Error: ' + result.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al guardar la degustaci√≥n', 'error');
      });
    };
  }
  
  // Guardar nuevo local - VERSI√ìN CORREGIDA
  const btnGuardarLocal = document.getElementById('btnGuardarLocal');
  if (btnGuardarLocal) {
    btnGuardarLocal.onclick = function() {
      console.log("Intentando crear nuevo local...");
      
      // Obtener datos del formulario de forma directa
      const nombre = document.querySelector('#formNuevoLocal input[name="nombre"]').value.trim();
      const direccion = document.querySelector('#formNuevoLocal input[name="direccion"]').value.trim();
      const ciudad = document.querySelector('#formNuevoLocal input[name="ciudad"]').value.trim();
      const pais = document.querySelector('#formNuevoLocal select[name="pais"]').value;
      
      console.log("Datos del local:", { nombre, direccion, ciudad, pais });
      
      // Validaci√≥n b√°sica
      if (!nombre) {
        mostrarNotificacion('El nombre del local es obligatorio', 'error');
        return;
      }
      
      const data = {
        nombre: nombre,
        direccion: direccion,
        ciudad: ciudad,
        pais: pais
      };
      
      console.log("Enviando datos:", data);
      
      // Agregar CSRF token
      const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
      const headers = {
        'Content-Type': 'application/json',
      };
      
      if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
      }
      
      // Hacer la petici√≥n
      fetch('/api/local/nuevo', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(data)
      })
      .then(response => {
        console.log("Respuesta recibida, status:", response.status);
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
      })
      .then(result => {
        console.log("Resultado:", result);
        if (result.success) {
          mostrarNotificacion(result.message, 'success');
          
          // Cerrar modal de nuevo local
          const modalNuevoLocal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoLocal'));
          modalNuevoLocal.hide();
          
          // Recargar lista de locales
          cargarLocales().then(() => {
            if (result.local_id) {
              document.getElementById('local_id').value = result.local_id;
              console.log("Local seleccionado:", result.local_id);
            }
            
            // ‚úÖ VOLVER AL MODAL DE DEGUSTACI√ìN despu√©s de un breve delay
            setTimeout(() => {
              const modalDegustacion = new bootstrap.Modal(document.getElementById('modalDegustacion'));
              modalDegustacion.show();
            }, 400);
          });
          
        } else {
          mostrarNotificacion(result.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error en la petici√≥n:', error);
        mostrarNotificacion('Error de conexi√≥n: ' + error.message, 'error');
      });
    };
  }
  
  // Bot√≥n para abrir modal de nuevo local - VERSI√ìN MEJORADA
  const btnNuevoLocal = document.getElementById('btnNuevoLocal');
  if (btnNuevoLocal) {
    btnNuevoLocal.onclick = function(e) {
      e.preventDefault();
      console.log("Abriendo modal de nuevo local...");
      
      const modalDegustacion = bootstrap.Modal.getInstance(document.getElementById('modalDegustacion'));
      const modalNuevoLocal = new bootstrap.Modal(document.getElementById('modalNuevoLocal'));
      
      // Limpiar formulario antes de abrir
      const form = document.getElementById('formNuevoLocal');
      if (form) {
        form.reset();
      }
      
      if (modalDegustacion) {
        modalDegustacion.hide();
      }
      
      // Peque√±o delay para asegurar que se cierra el modal anterior
      setTimeout(() => {
        modalNuevoLocal.show();
      }, 300);
    };
  }

  // --- BOTONES DE CANCELAR MEJORADOS ---
  
  // Bot√≥n cancelar en modal de nuevo local - VERSI√ìN CORREGIDA
  const btnCancelarLocal = document.getElementById('btnCancelarLocal');
  if (btnCancelarLocal) {
      btnCancelarLocal.onclick = function() {
          console.log("Cancelando creaci√≥n de local...");
          const modalNuevoLocal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoLocal'));
          modalNuevoLocal.hide();
          
          // ‚úÖ VOLVER AL MODAL DE DEGUSTACI√ìN despu√©s de cancelar
          setTimeout(() => {
              const modalDegustacion = new bootstrap.Modal(document.getElementById('modalDegustacion'));
              modalDegustacion.show();
          }, 300);
      };
  }

  // Bot√≥n cerrar (X) en modal de nuevo local
  const btnCerrarLocal = document.getElementById('btnCerrarLocal');
  if (btnCerrarLocal) {
      btnCerrarLocal.onclick = function() {
          console.log("Cerrando modal de local...");
          const modalNuevoLocal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoLocal'));
          modalNuevoLocal.hide();
          
          // ‚úÖ VOLVER AL MODAL DE DEGUSTACI√ìN
          setTimeout(() => {
              const modalDegustacion = new bootstrap.Modal(document.getElementById('modalDegustacion'));
              modalDegustacion.show();
          }, 300);
      };
  }

  // Bot√≥n cancelar en modal de degustaci√≥n
  const btnCancelarDegustacion = document.getElementById('btnCancelarDegustacion');
  if (btnCancelarDegustacion) {
      btnCancelarDegustacion.onclick = function() {
          console.log("Cancelando degustaci√≥n...");
          const modalDegustacion = bootstrap.Modal.getInstance(document.getElementById('modalDegustacion'));
          modalDegustacion.hide();
      };
  }
  // Bot√≥n cerrar (X) en modal de degustaci√≥n
  const btnCerrarDegustacion = document.querySelector('#modalDegustacion .btn-close');
  if (btnCerrarDegustacion) {
      btnCerrarDegustacion.onclick = function() {
          console.log("Cerrando modal de degustaci√≥n...");
          const modalDegustacion = bootstrap.Modal.getInstance(document.getElementById('modalDegustacion'));
          modalDegustacion.hide();
      };
  }
  // --- FIN CARGA INICIAL ---
});

function cargarSugerencias() {
  if (sugerenciasMostradas) return;
  fetch('/buscar_cervezas')
    .then(res => res.json())
    .then(data => {
      renderizarLista(data.cervezas);
      document.getElementById('resultados').dataset.cervezas = JSON.stringify(data.cervezas);
      sugerenciasMostradas = true;
    });
}

function ocultarSugerenciasSiVacio() {
  const input = document.getElementById('buscador');
  if (input.value.trim() === '') {
    document.getElementById('resultados').innerHTML = '';
    sugerenciasMostradas = false;
  }
}
</script>
{% endblock %}