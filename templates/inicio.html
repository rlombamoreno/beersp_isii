{% extends "base.html" %}
{% block content %}
<div class="card p-4">
  <!-- Men√∫ general -->
  <nav class="nav nav-pills nav-fill mb-4">
    <a class="nav-link active" href="{{ url_for('inicio', id=usuario.id) }}">Inicio</a>
    <a class="nav-link" href="#">Top Degustaciones</a>
    <a class="nav-link" href="{{ url_for('perfil', id=usuario.id) }}">Mi Perfil</a>
    <a class="nav-link" href="#">Buscar</a>
    <a class="nav-link" href="{{ url_for('logout') }}">Cerrar sesi√≥n</a>
  </nav>

  <!-- Panel resumen -->
  <div class="mb-4">
    <h5 class="border-bottom pb-2">Mi perfil</h5>
    <div class="d-flex align-items-center mb-3">
      {% if usuario.foto %}
        <img src="{{ url_for('static', filename='fotos/' + usuario.foto) }}"
             class="rounded-circle me-3" width="60" height="60" style="object-fit:cover;">
      {% else %}
        <div class="bg-light rounded-circle me-3 d-flex align-items-center justify-content-center"
             style="width:60px;height:60px;">
          <span class="text-muted">{{ usuario.nombre_usuario[0]|upper }}</span>
        </div>
      {% endif %}
      <div>
        <h6 class="mb-0">{{ usuario.nombre_usuario }}</h6>
        <small class="text-muted">Miembro desde {{ usuario.fecha_registro.strftime('%B %Y') }}</small>
      </div>
    </div>
    <ul class="list-unstyled small">
      <li>‚úÖ {{ stats.degustaciones }} degustaciones</li>
      <li>üìç {{ stats.locales_nuevos }} locales nuevos (√∫ltimos 7 d√≠as)</li>
    </ul>
    {% if stats.solicitudes_amistad > 0 %}
      <div class="alert alert-info p-2 mt-2">
        üì© Tienes <strong>{{ stats.solicitudes_amistad }}</strong> solicitud(es) de amistad pendiente(s).
      </div>
    {% endif %}
  </div>

  <!-- üîç Buscador -->
  <div class="mb-4">
    <h5 class="border-bottom pb-2">üîç Buscar cerveza</h5>
    <div class="input-group mb-3">
      <input type="text" id="buscador" class="form-control" 
             placeholder="Nombre o estilo (ej: IPA, stout, belga...)">
      <button class="btn btn-outline-secondary" type="button" id="btnBuscar">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
        </svg>
      </button>
    </div>
    <div id="resultados" class="mt-3">
      <!-- Vac√≠o al inicio -->
    </div>
  </div>

  <!-- ‚úÖ Secci√≥n de favoritas: ahora persistente -->
  <div id="seccionFavoritas" class="mb-4 d-none">
    <h5 class="border-bottom pb-2 d-flex justify-content-between align-items-center">
      Mis cervezas favoritas
      <button class="btn btn-sm btn-outline-secondary d-none" id="btnVerTodasFavoritas">Ver todas</button>
    </h5>
    <ul class="list-unstyled" id="listaFavoritas"></ul>
  </div>

  <!-- Amigos / galardones (sin cambios) -->
  {% if amigos_activos %}
  <div class="mb-4">
    <h5 class="border-bottom pb-2">Amigos activos</h5>
    {% for amigo in amigos_activos %}
      <p class="mb-1"><strong>{{ amigo.nombre_usuario }}</strong> degust√≥ <em>{{ amigo.ultima_cerveza }}</em></p>
    {% endfor %}
    <a href="#" class="btn btn-sm btn-outline-secondary">Ver todos</a>
  </div>
  {% endif %}

  {% if galardones %}
  <div>
    <h5 class="border-bottom pb-2">Mis √∫ltimos galardones</h5>
    <div class="d-flex flex-wrap gap-2">
      {% for galardon in galardones %}
        <span class="badge bg-warning text-dark">
          {{ galardon.nombre }} (Nv. {{ galardon.nivel }})
        </span>
      {% endfor %}
    </div>
    <a href="#" class="btn btn-sm btn-outline-secondary mt-2">Ver todos</a>
  </div>
  {% endif %}
</div>

<!-- Modal -->
<div class="modal fade" id="modalCerveza" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Cerveza</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Estilo:</strong> <span id="modalEstilo"></span></p>
        <p><strong>Pa√≠s:</strong> <span id="modalPais"></span></p>
        <p><strong>Alcohol:</strong> <span id="modalABV"></span>% ABV</p>
        <p><strong>IBU (amargor):</strong> <span id="modalIBU"></span></p>
        <p><strong>Color:</strong> <span id="modalColor"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-warning" id="btnFavorita"></button>
        <button type="button" class="btn btn-beersp" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cup-straw me-1" viewBox="0 0 16 16">
            <path d="M4.5 4a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 1 0v-7a.5.5 0 0 0-.5-.5z"/>
            <path d="M11.517 3.156L13.5 4.194v1.388l-1.983 1.038A2.5 2.5 0 0 0 10 7.5v4.793l-1.5-1.5A1.5 1.5 0 0 0 6.379 10H3.5a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .293-.459L7.5 1.022V.5a.5.5 0 0 1 1 0v.522l4.217 2.134a.5.5 0 0 1 .291.459z"/>
          </svg>
          Registrar degustaci√≥n
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ‚úÖ 1. Recuperar favoritas AL CARGAR la p√°gina
const FAVORITAS_KEY = 'beersp_favoritas_usuario_{{ usuario.id }}';
let favoritas = JSON.parse(localStorage.getItem(FAVORITAS_KEY) || '[]');
const cervezasCache = {};
let sugerenciasMostradas = false;

// ‚úÖ 2. Funci√≥n para mostrar favoritas (sin "undefined")
function actualizarSeccionFavoritas() {
  const seccion = document.getElementById('seccionFavoritas');
  const lista = document.getElementById('listaFavoritas');
  const btn = document.getElementById('btnVerTodasFavoritas');
  
  // ‚úÖ Si no hay favoritas, ocultar secci√≥n
  if (favoritas.length === 0) {
    seccion.classList.add('d-none');
    return;
  }

  seccion.classList.remove('d-none');

  // ‚úÖ Solo mostrar las que est√°n en cach√© (evita errores)
  const disponibles = favoritas.filter(id => cervezasCache[id]);
  
  if (disponibles.length === 0) {
    seccion.classList.add('d-none');
    return;
  }

  // ‚úÖ Mostrar hasta 3 por defecto
  const paraMostrar = disponibles.slice(0, 3);
  lista.innerHTML = paraMostrar.map(id => {
    const c = cervezasCache[id];
    // ‚úÖ Mostrar ‚≠ê solo si hay puntuaci√≥n
    const puntuacionStr = c.puntuacion !== undefined && c.puntuacion !== null 
      ? ` ‚Äî ‚≠ê ${parseFloat(c.puntuacion).toFixed(1)}` 
      : '';
    return `<li>${c.nombre} (${c.estilo})${puntuacionStr}</li>`;
  }).join('');

  // ‚úÖ "Ver todas" solo si hay +3
  if (disponibles.length > 3) {
    btn.classList.remove('d-none');
    const todasExistentes = document.getElementById('favoritasTodas');
    if (todasExistentes) todasExistentes.remove();

    btn.onclick = () => {
      const todasDiv = document.createElement('div');
      todasDiv.id = 'favoritasTodas';
      todasDiv.classList.add('mt-2');
      todasDiv.innerHTML = disponibles.slice(3).map(id => {
        const c = cervezasCache[id];
        const puntuacionStr = c.puntuacion !== undefined && c.puntuacion !== null 
          ? ` ‚Äî ‚≠ê ${parseFloat(c.puntuacion).toFixed(1)}` 
          : '';
        return `<li>${c.nombre} (${c.estilo})${puntuacionStr}</li>`;
      }).join('');
      lista.parentNode.appendChild(todasDiv);
      btn.textContent = 'Ver menos';
      btn.onclick = () => {
        todasDiv.remove();
        btn.textContent = 'Ver todas';
      };
    };
  } else {
    btn.classList.add('d-none');
  }
}

// ‚úÖ 3. Almacenar cerveza en cach√© con su puntuaci√≥n (si la tiene)
function cachearCerveza(cerveza, puntuacion = null) {
  cervezasCache[cerveza.id] = {
    id: cerveza.id,
    nombre: cerveza.nombre,
    estilo: cerveza.estilo,
    abv: cerveza.porcentaje_alcohol,
    pais: cerveza.pais_procedencia,
    ibu: cerveza.ibu || 'N/A',
    color: cerveza.color,
    puntuacion: puntuacion  // ‚úÖ ahora guardamos puntuaci√≥n aqu√≠
  };
}

// ‚úÖ Renderizar lista (usando cachearCerveza)
function renderizarLista(cervezas) {
  let html = `<div class="list-group">`;
  cervezas.forEach(c => {
    // ‚úÖ Si ya est√° en favoritas, usar su puntuaci√≥n; si no, null
    const puntuacion = favoritas.includes(c.id) 
      ? (cervezasCache[c.id]?.puntuacion || 5.0)  // por defecto 5 si no hay
      : null;
    cachearCerveza(c, puntuacion);

    const esFavorita = favoritas.includes(c.id);
    const estrella = esFavorita 
      ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
      : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg>';

    html += `
      <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
         data-bs-toggle="modal" data-bs-target="#modalCerveza"
         data-id="${c.id}"
         data-nombre="${c.nombre}"
         data-estilo="${c.estilo}"
         data-pais="${c.pais_procedencia}"
         data-abv="${c.porcentaje_alcohol}"
         data-ibu="${c.ibu || 'N/A'}"
         data-color="${c.color}">
        <div>
          <strong>${c.nombre}</strong><br>
          <small class="text-muted">${c.estilo} ¬∑ ${c.pais_procedencia}</small>
        </div>
        <div>
          <span class="badge bg-secondary me-1">${c.porcentaje_alcohol}%</span>
          ${estrella}
        </div>
      </a>
    `;
  });
  html += `</div>`;
  document.getElementById('resultados').innerHTML = html;
}

// ‚úÖ Bot√≥n de favoritas en modal
function actualizarBotonFavorita(id) {
  const btn = document.getElementById('btnFavorita');
  const esFavorita = favoritas.includes(id);
  btn.innerHTML = `
    ${esFavorita 
      ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill me-1" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
      : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star me-1" viewBox="0 0 16 16"><path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg>'
    }
    <span>${esFavorita ? 'En favoritas' : 'Agregar a favoritas'}</span>
  `;
  btn.onclick = () => {
    if (esFavorita) {
      favoritas = favoritas.filter(x => x !== id);
    } else {
      favoritas.push(id);
      // ‚úÖ Asignar puntuaci√≥n 5.0 por defecto al marcar
      if (cervezasCache[id]) {
        cervezasCache[id].puntuacion = 5.0;
      }
    }
    localStorage.setItem(FAVORITAS_KEY, JSON.stringify(favoritas));
    actualizarSeccionFavoritas(); // ‚úÖ ahora se actualiza al instante
    const current = JSON.parse(document.getElementById('resultados').dataset.cervezas || '[]');
    renderizarLista(current);
    actualizarBotonFavorita(id);
  };
}

// ‚úÖ Cargar sugerencias (sin cambios)
function cargarSugerencias() {
  if (sugerenciasMostradas) return;
  fetch('/buscar_cervezas')
    .then(res => res.json())
    .then(data => {
      renderizarLista(data.cervezas);
      document.getElementById('resultados').dataset.cervezas = JSON.stringify(data.cervezas);
      sugerenciasMostradas = true;
    });
}

function ocultarSugerenciasSiVacio() {
  const input = document.getElementById('buscador');
  if (input.value.trim() === '') {
    document.getElementById('resultados').innerHTML = '';
    sugerenciasMostradas = false;
  }
}

// ‚úÖ INICIALIZACI√ìN: recuperar favoritas y actualizar UI
document.addEventListener('DOMContentLoaded', () => {
  // ‚úÖ 1. Recuperar favoritas y actualizar secci√≥n
  actualizarSeccionFavoritas();

  // ‚úÖ 2. Eventos de b√∫squeda
  const buscador = document.getElementById('buscador');
  const btnBuscar = document.getElementById('btnBuscar');

  buscador.addEventListener('focus', cargarSugerencias);
  buscador.addEventListener('input', () => {
    const q = buscador.value.trim();
    if (q === '') {
      cargarSugerencias();
    } else {
      fetch(`/buscar_cervezas?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
          renderizarLista(data.cervezas);
          document.getElementById('resultados').dataset.cervezas = JSON.stringify(data.cervezas);
        });
    }
  });
  btnBuscar.addEventListener('click', () => {
    const q = buscador.value.trim();
    if (q) {
      fetch(`/buscar_cervezas?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
          renderizarLista(data.cervezas);
          document.getElementById('resultados').dataset.cervezas = JSON.stringify(data.cervezas);
        });
    } else {
      buscador.focus();
    }
  });
  buscador.addEventListener('blur', () => {
    setTimeout(ocultarSugerenciasSiVacio, 150);
  });

  // ‚úÖ 3. Modal
  const modal = document.getElementById('modalCerveza');
  if (modal) {
    modal.addEventListener('show.bs.modal', function (event) {
      const b = event.relatedTarget;
      const id = parseInt(b.getAttribute('data-id'));
      document.getElementById('modalTitle').textContent = b.getAttribute('data-nombre');
      document.getElementById('modalEstilo').textContent = b.getAttribute('data-estilo');
      document.getElementById('modalPais').textContent = b.getAttribute('data-pais');
      document.getElementById('modalABV').textContent = b.getAttribute('data-abv');
      document.getElementById('modalIBU').textContent = b.getAttribute('data-ibu');
      document.getElementById('modalColor').textContent = b.getAttribute('data-color');
      actualizarBotonFavorita(id);
    });
  }
});
</script>
{% endblock %}