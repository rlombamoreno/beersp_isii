{% extends "base.html" %}

{% block content %}
<div class="card p-4">
  <!-- Men√∫ general MEJORADO -->
  <nav class="nav nav-pills nav-fill mb-4">
    <a class="nav-link active" href="{{ url_for('inicio') }}?user_id={{ user_id }}">üè† Inicio</a>
    <a class="nav-link" href="{{ url_for('mis_degustaciones') }}?user_id={{ user_id }}">üç∫ Mis Degustaciones</a>
    <a class="nav-link" href="{{ url_for('top_degustaciones') }}?user_id={{ user_id }}">‚≠ê Top Degustaciones</a>
    <a class="nav-link" href="{{ url_for('amigos') }}?user_id={{ user_id }}">üë• Amigos</a>
    <a class="nav-link" href="{{ url_for('mi_perfil') }}?user_id={{ user_id }}">üë§ Mi Perfil</a>
    <a class="nav-link" href="{{ url_for('logout') }}">üö™ Cerrar sesi√≥n</a>
  </nav>
  
  <!-- Panel resumen MEJORADO -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title border-bottom pb-2">üìä Mi resumen</h5>
      <div class="d-flex align-items-center mb-3">
        {% if usuario.foto %}
          <img src="{{ url_for('static', filename='fotos/' + usuario.foto) }}"
               class="rounded-circle me-3" width="60" height="60" style="object-fit:cover;">
        {% else %}
          <div class="bg-light rounded-circle me-3 d-flex align-items-center justify-content-center"
               style="width:60px;height:60px;">
            <span class="text-muted fs-5">{{ usuario.nombre_usuario[0]|upper }}</span>
          </div>
        {% endif %}
        <div>
          <h6 class="mb-0">{{ usuario.nombre_usuario }}</h6>
          <small class="text-muted">Miembro desde {{ usuario.fecha_registro.strftime('%B %Y') }}</small>
        </div>
      </div>
      
      <div class="row text-center">
        <div class="col-4">
          <div class="p-2 bg-light rounded">
            <h4 class="text-beersp mb-0">{{ stats.degustaciones }}</h4>
            <small class="text-muted">Degustaciones</small>
          </div>
        </div>
        <div class="col-4">
          <div class="p-2 bg-light rounded">
            <h4 class="text-beersp mb-0">{{ stats.solicitudes_amistad }}</h4>
            <small class="text-muted">Solicitudes</small>
          </div>
        </div>
      </div>
      
      {% if stats.solicitudes_amistad > 0 %}
        <div class="alert alert-info p-2 mt-3 d-flex justify-content-between align-items-center">
          <div>
            <strong>üì© Tienes {{ stats.solicitudes_amistad }} solicitud(es) pendiente(s)</strong>
          </div>
          <a href="{{ url_for('amigos') }}?user_id={{ user_id }}" class="btn btn-sm btn-beersp">Ver solicitudes</a>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- üîç Buscador MEJORADO -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title border-bottom pb-2">üîç Buscar cerveza</h5>
      <p class="text-muted small mb-3">Busca por nombre o estilo de cerveza</p>
      <div class="input-group mb-3">
        <input type="text" id="buscador" class="form-control"
               placeholder="Ej: IPA, stout, belga, Moritz...">
        <button class="btn btn-beersp" type="button" id="btnBuscar">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
          </svg>
        </button>
      </div>
      <div id="resultados" class="mt-3">
        <!-- Vac√≠o al inicio -->
      </div>
    </div>
  </div>
  
  <!-- ‚úÖ Secci√≥n de favoritas -->
  <div id="seccionFavoritas" class="card mb-4 d-none">
    <div class="card-body">
      <h5 class="card-title border-bottom pb-2 d-flex justify-content-between align-items-center">
        ‚≠ê Mis cervezas favoritas
        <button class="btn btn-sm btn-outline-secondary d-none" id="btnVerTodasFavoritas">Ver todas</button>
      </h5>
      <div id="listaFavoritas" class="mb-2"></div>
      <div id="favoritasTodas" class="mt-2 border-top pt-2 d-none"></div>
    </div>
  </div>
  
  <!-- üë• Amigos activos MEJORADO -->
   {% if amigos_activos %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title border-bottom pb-2">üë• Amigos activos</h5>
      <p class="text-muted small mb-3">√öltimas degustaciones de tus amigos</p>
      {% for amigo in amigos_activos %}
        <div class="d-flex align-items-center mb-2">
          <div class="flex-shrink-0">
            {% if amigo.foto %}
              <img src="{{ url_for('static', filename='fotos/' + amigo.foto) }}"
                   class="rounded-circle" width="40" height="40" style="object-fit:cover;">
            {% else %}
              <div class="bg-light rounded-circle d-flex align-items-center justify-content-center"
                   style="width:40px;height:40px;">
                <span class="text-muted">{{ amigo.nombre_usuario[0]|upper }}</span>
              </div>
            {% endif %}
          </div>
          <div class="flex-grow-1 ms-3">
            <a href="{{ url_for('ver_perfil_usuario', id=amigo.id) }}?user_id={{ user_id }}" class="text-decoration-none">
            <strong>{{ amigo.nombre_usuario }}</strong>
            </a>
            <small class="text-muted d-block">degust√≥ {{ amigo.ultima_cerveza }}</small>
          </div>
        </div>
      {% endfor %}
      <div class="text-center mt-3">
        <a href="{{ url_for('amigos') }}?user_id={{ user_id }}" class="btn btn-sm btn-outline-beersp">
          Ver todos los amigos ‚Üí
        </a>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- üèÜ Galardones MEJORADO -->
  {% if galardones %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title border-bottom pb-2">üèÜ Mis galardones</h5>
      <div class="d-flex flex-wrap gap-2 mb-3">
        {% for galardon in galardones %}
          <div class="badge bg-warning text-dark p-2 d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trophy me-1" viewBox="0 0 16 16">
              <path d="M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5c0 .538-.012 1.05-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33.076 33.076 0 0 1 2.5.5zm.099 2.54a2 2 0 0 0 .72 3.935c-.333-1.05-.588-2.346-.72-3.935zm10.083 3.935a2 2 0 0 0 .72-3.935c-.133 1.59-.388 2.885-.72 3.935zM3.504 1c.007.517.026 1.006.056 1.469.13 2.028.457 3.546.87 4.667C5.294 9.48 6.484 10 7 10a.5.5 0 0 1 .5.5v2.61a1 1 0 0 1-.757.97l-1.426.356a.5.5 0 0 0-.179.085L4.5 15h7l-.638-.479a.5.5 0 0 0-.18-.085l-1.425-.356a1 1 0 0 1-.757-.97V10.5A.5.5 0 0 1 9 10c.516 0 1.706-.52 2.57-2.864.413-1.12.74-2.64.87-4.667.03-.463.049-.952.056-1.469H3.504z"/>
            </svg>
            {{ galardon.nombre }} (Nv. {{ galardon.nivel }})
          </div>
        {% endfor %}
      </div>
      <div class="text-center">
        <a href="#" class="btn btn-sm btn-outline-beersp">Ver todos mis galardones ‚Üí</a>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- üöÄ Acciones r√°pidas -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title border-bottom pb-2">üöÄ Acciones r√°pidas</h5>
      <div class="row g-2">
        <div class="col-md-6">
          <a href="{{ url_for('top_degustaciones') }}?user_id={{ user_id }}" class="btn btn-outline-beersp w-100 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star me-1" viewBox="0 0 16 16">
              <path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/>
            </svg>
            Ver top cervezas
          </a>
        </div>
        <div class="col-md-6">
          <a href="{{ url_for('amigos') }}?user_id={{ user_id }}" class="btn btn-outline-beersp w-100 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-people me-1" viewBox="0 0 16 16">
              <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8Zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022ZM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816ZM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0Zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z"/>
            </svg>
            Gestionar amigos
          </a>
        </div>
        <div class="col-md-6">
          <!-- ENLACE CORREGIDO -->
          <a href="{{ url_for('mis_degustaciones') }}?user_id={{ user_id }}" class="btn btn-outline-beersp w-100 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cup-straw me-1" viewBox="0 0 16 16">
              <path d="M4.5 4a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 1 0v-7a.5.5 0 0 0-.5-.5z"/>
              <path d="M11.517 3.156L13.5 4.194v1.388l-1.983 1.038A2.5 2.5 0 0 0 10 7.5v4.793l-1.5-1.5A1.5 1.5 0 0 0 6.379 10H3.5a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .293-.459L7.5 1.022V.5a.5.5 0 0 1 1 0v.522l4.217 2.134a.5.5 0 0 1 .291.459z"/>
            </svg>
            Mis degustaciones
          </a>
        </div>
        <div class="col-md-6">
          <!-- ENLACE CORREGIDO -->
          <a href="{{ url_for('mi_perfil') }}?user_id={{ user_id }}" class="btn btn-outline-beersp w-100 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle me-1" viewBox="0 0 16 16">
              <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
              <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
            </svg>
            Mi perfil
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Cerveza -->
<div class="modal fade" id="modalCerveza" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Cerveza</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Estilo:</strong> <span id="modalEstilo"></span></p>
        <p><strong>Pa√≠s:</strong> <span id="modalPais"></span></p>
        <p><strong>Alcohol:</strong> <span id="modalABV"></span>% ABV</p>
        <p><strong>IBU (amargor):</strong> <span id="modalIBU"></span></p>
        <p><strong>Color:</strong> <span id="modalColor"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-warning" id="btnFavorita"></button>
        <button type="button" class="btn btn-beersp" id="btnRegistrarDegustacion">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cup-straw me-1" viewBox="0 0 16 16">
            <path d="M4.5 4a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 1 0v-7a.5.5 0 0 0-.5-.5z"/>
            <path d="M11.517 3.156L13.5 4.194v1.388l-1.983 1.038A2.5 2.5 0 0 0 10 7.5v4.793l-1.5-1.5A1.5 1.5 0 0 0 6.379 10H3.5a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .293-.459L7.5 1.022V.5a.5.5 0 0 1 1 0v.522l4.217 2.134a.5.5 0 0 1 .291.459z"/>
          </svg>
          Registrar degustaci√≥n
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Incluir modales de degustaci√≥n -->
{% include 'modal_degustacion.html' %}

<!-- El resto del JavaScript permanece igual -->
<script>
// --- CARGA INICIAL: IDs de favoritas desde el backend ---
const favoritasIds = {{ favoritas_ids | tojson }}; // Recibido del backend
// --- FIN CARGA ---
const cervezasCache = {};
let sugerenciasMostradas = false;

// Funci√≥n para mostrar notificaciones sutiles
function mostrarNotificacion(mensaje, tipo = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger', 
        'info': 'alert-info',
        'warning': 'alert-warning'
    }[tipo] || 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    notification.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-eliminar despu√©s de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// --- SISTEMA DE PA√çSES DESDE API ---

// Funci√≥n para cargar pa√≠ses desde REST Countries API
function cargarPaises() {
    console.log("üåç Cargando pa√≠ses desde API...");
    return fetch('https://restcountries.com/v3.1/all?fields=name,translations')
        .then(response => {
            if (!response.ok) throw new Error('Error al cargar pa√≠ses desde API');
            return response.json();
        })
        .then(data => {
            const paises = data.map(country => 
                country.translations?.spa?.common || country.name.common
            ).sort();
            
            console.log(`‚úÖ ${paises.length} pa√≠ses cargados desde API`);
            return paises;
        })
        .catch(error => {
            console.error('Error cargando pa√≠ses:', error);
            // Fallback b√°sico si la API falla
            mostrarNotificacion('Usando lista local de pa√≠ses', 'info');
            return [
                "Alemania", "B√©lgica", "Espa√±a", "Francia", "Italia", "Pa√≠ses Bajos",
                "Portugal", "Reino Unido", "Estados Unidos", "M√©xico", "Argentina",
                "Brasil", "Chile", "Colombia", "Per√∫", "Austria", "Dinamarca",
                "Noruega", "Suecia", "Suiza", "Rep√∫blica Checa", "Polonia"
            ];
        });
}

// Funci√≥n para llenar selects de pa√≠ses
function llenarSelectPaises(paises) {
    const selectPaisConsumo = document.getElementById('pais_consumicion');
    const selectPaisLocal = document.querySelector('#formNuevoLocal select[name="pais"]');
    const selectPaisCerveza = document.getElementById('nuevaCervezaPais');
    
    // Llenar select de consumo
    if (selectPaisConsumo) {
        selectPaisConsumo.innerHTML = '<option value="">Seleccionar pa√≠s...</option>';
        paises.forEach(pais => {
            const option = document.createElement('option');
            option.value = pais;
            option.textContent = pais;
            selectPaisConsumo.appendChild(option);
        });
    }
    
    // Llenar select de local
    if (selectPaisLocal) {
        selectPaisLocal.innerHTML = '<option value="">Seleccionar pa√≠s...</option>';
        paises.forEach(pais => {
            const option = document.createElement('option');
            option.value = pais;
            option.textContent = pais;
            selectPaisLocal.appendChild(option);
        });
        
        // Poner Espa√±a por defecto en el formulario de local
        const opcionEspa√±a = Array.from(selectPaisLocal.options).find(opt => opt.value === "Espa√±a");
        if (opcionEspa√±a) {
            selectPaisLocal.value = "Espa√±a";
        }
    }
    
    // Llenar select de cerveza
    if (selectPaisCerveza) {
        selectPaisCerveza.innerHTML = '<option value="">Seleccionar pa√≠s...</option>';
        paises.forEach(pais => {
            const option = document.createElement('option');
            option.value = pais;
            option.textContent = pais;
            selectPaisCerveza.appendChild(option);
        });
        
        // Poner Espa√±a por defecto en el formulario de cerveza
        const opcionEspa√±a = Array.from(selectPaisCerveza.options).find(opt => opt.value === "Espa√±a");
        if (opcionEspa√±a) {
            selectPaisCerveza.value = "Espa√±a";
        }
    }
}

function actualizarSeccionFavoritas() {
  const seccion = document.getElementById('seccionFavoritas');
  const lista = document.getElementById('listaFavoritas');
  const todasDiv = document.getElementById('favoritasTodas');
  const btn = document.getElementById('btnVerTodasFavoritas');

  const disponibles = favoritasIds.filter(id => cervezasCache[id]);
  
  if (disponibles.length === 0) {
    seccion.classList.add('d-none');
    return;
  }
  
  seccion.classList.remove('d-none');
  const primeras3 = disponibles.slice(0, 3);
  const resto = disponibles.slice(3);
  
  // Renderizar primeras 3
  lista.innerHTML = '';
  primeras3.forEach(id => {
    const c = cervezasCache[id];
    const puntuacionStr = c.puntuacion !== undefined && c.puntuacion !== null
      ? ` ‚Äî ‚≠ê ${parseFloat(c.puntuacion).toFixed(1)}`
      : '';
    
    const div = document.createElement('div');
    div.className = 'd-flex align-items-center mb-2';
    div.innerHTML = `
      <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2"
           style="width:30px;height:30px;">
        <small class="text-beersp">üç∫</small>
      </div>
      <div class="flex-grow-1">
        <strong class="d-block">${c.nombre}</strong>
        <small class="text-muted d-block">${c.estilo}${puntuacionStr}</small>
      </div>
    `;
    lista.appendChild(div);
  });
  
  // Renderizar resto (oculto por defecto)
  todasDiv.innerHTML = '';
  todasDiv.classList.add('d-none');
  
  if (resto.length > 0) {
    resto.forEach(id => {
      const c = cervezasCache[id];
      const puntuacionStr = c.puntuacion !== undefined && c.puntuacion !== null
        ? ` ‚Äî ‚≠ê ${parseFloat(c.puntuacion).toFixed(1)}`
        : '';
      
      const div = document.createElement('div');
      div.className = 'd-flex align-items-center mb-2';
      div.innerHTML = `
        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2"
             style="width:30px;height:30px;">
          <small class="text-beersp">üç∫</small>
        </div>
        <div class="flex-grow-1">
          <strong class="d-block">${c.nombre}</strong>
          <small class="text-muted d-block">${c.estilo}${puntuacionStr}</small>
        </div>
      `;
      todasDiv.appendChild(div);
    });
    
    // Mostrar bot√≥n
    btn.classList.remove('d-none');
    btn.textContent = 'Ver todas';
    btn.classList.remove('btn-secondary');
    btn.classList.add('btn-outline-secondary');
    
    btn.onclick = () => {
      if (todasDiv.classList.contains('d-none')) {
        // Mostrar todas
        todasDiv.classList.remove('d-none');
        btn.textContent = 'Ver menos';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-secondary');
      } else {
        // Ocultar
        todasDiv.classList.add('d-none');
        btn.textContent = 'Ver todas';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-outline-secondary');
      }
    };
  } else {
    btn.classList.add('d-none');
  }
}
// --- FIN ACTUALIZAR ---

// --- CACHear Cerveza ---
function cachearCerveza(cerveza, puntuacion = null) {
  cervezasCache[cerveza.id] = {
    id: cerveza.id,
    nombre: cerveza.nombre,
    estilo: cerveza.estilo,
    abv: cerveza.porcentaje_alcohol,
    pais: cerveza.pais_procedencia,
    ibu: cerveza.ibu || 'N/A',
    color: cerveza.color,
    puntuacion: puntuacion
  };
}
// --- FIN CACHear ---

// --- RENDERIZAR LISTA ACTUALIZADA ---
function renderizarLista(data) {
  const { cervezas, query } = data;
  
  // Si no hay cervezas Y hay una query (b√∫squeda espec√≠fica), mostrar bot√≥n de a√±adir
  if (!cervezas.length && query) {
    document.getElementById('resultados').innerHTML = `
      <div class="text-center py-4">
        <p class="text-muted">No se encontraron cervezas con "<strong>${query}</strong>".</p>
        <button class="btn btn-beersp" id="btnAnadirCerveza" data-query="${query}">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus me-1" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
          </svg>
          A√±adir "${query}" como nueva cerveza
        </button>
      </div>
    `;
    return;
  }
  
  // Si no hay cervezas y no hay query (carga inicial), mostrar mensaje de carga
  if (!cervezas.length) {
    document.getElementById('resultados').innerHTML = `
      <div class="text-center py-4">
        <div class="spinner-border text-warning" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-muted">Cargando cervezas sugeridas...</p>
      </div>
    `;
    return;
  }
  
  // Si hay cervezas, renderizar la lista normal
  let html = `<div class="list-group">`;
  cervezas.forEach(c => {
    const puntuacion = favoritasIds.includes(c.id)
      ? (cervezasCache[c.id]?.puntuacion || 5.0)
      : null;
    cachearCerveza(c, puntuacion);
    const esFavorita = favoritasIds.includes(c.id);
    const estrella = esFavorita
      ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
      : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg>';
    html += `
      <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
         data-bs-toggle="modal" data-bs-target="#modalCerveza"
         data-id="${c.id}"
         data-nombre="${c.nombre}"
         data-estilo="${c.estilo}"
         data-pais="${c.pais_procedencia}"
         data-abv="${c.porcentaje_alcohol}"
         data-ibu="${c.ibu || 'N/A'}"
         data-color="${c.color}">
        <div>
          <strong>${c.nombre}</strong><br>
          <small class="text-muted">${c.estilo} ¬∑ ${c.pais_procedencia}</small>
        </div>
        <div>
          <span class="badge bg-beersp me-1">${c.porcentaje_alcohol}%</span>
          ${estrella}
        </div>
      </a>
    `;
  });
  html += `</div>`;
  document.getElementById('resultados').innerHTML = html;
}
// --- FIN RENDERIZAR ---

// --- ACTUALIZAR BOTON FAVORITA ---
function actualizarBotonFavorita(id) {
  const btn = document.getElementById('btnFavorita');
  btn.innerHTML = '';
  btn.onclick = null;
  const esFavorita = favoritasIds.includes(id);
  
  const icono = esFavorita
    ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
    : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg>';
  
  btn.innerHTML = `${icono} <span class="ms-1">${esFavorita ? 'En favoritas' : 'Agregar a favoritas'}</span>`;
  
  btn.onclick = function() {
    console.log("Intentando toggle favorita para cerveza ID:", id);
    
    // Agregar token CSRF si est√° disponible
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
    const headers = {
      'Content-Type': 'application/json',
    };
    
    if (csrfToken) {
      headers['X-CSRFToken'] = csrfToken;
    }
    
    fetch('/toggle_favorita', {
      method: 'POST',
      headers: headers,
      credentials: 'include',
      body: JSON.stringify({ cerveza_id: id })
    })
    .then(response => {
      console.log("Respuesta recibida, status:", response.status);
      if (response.status === 401) {
        // Sesi√≥n expirada
        mostrarNotificacion('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.', 'error');
        window.location.href = '/login';
        return Promise.reject('Sesi√≥n expirada');
      }
      if (!response.ok) {
        return response.text().then(text => { 
          throw new Error(`Error ${response.status}: ${text}`); 
        });
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        if (data.action === 'added') {
          // Agregar a favoritas
          if (!favoritasIds.includes(id)) {
            favoritasIds.push(id);
          }
          btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg> <span class="ms-1">En favoritas</span>`;
          
          if (cervezasCache[id]) {
            cervezasCache[id].puntuacion = 5.0;
          }
          mostrarNotificacion('Cerveza a√±adida a favoritas', 'success');
        } else if (data.action === 'removed') {
          // Remover de favoritas
          const index = favoritasIds.indexOf(id);
          if (index > -1) {
            favoritasIds.splice(index, 1);
          }
          btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg> <span class="ms-1">Agregar a favoritas</span>`;
          
          if (cervezasCache[id]) {
            delete cervezasCache[id].puntuacion;
          }
          mostrarNotificacion('Cerveza eliminada de favoritas', 'info');
        }
        
        // Actualizar visualmente en la lista
        actualizarEstrellaEnLista(id, data.action === 'added');
        
        // Actualizar secci√≥n de favoritas
        actualizarSeccionFavoritas();
        
      } else {
        console.error('Error del servidor:', data.message);
        mostrarNotificacion('Error: ' + data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Error de red o en la solicitud:', error);
      if (error !== 'Sesi√≥n expirada') {
        mostrarNotificacion('Hubo un problema al actualizar', 'error');
      }
    });
  };
}

// Funci√≥n auxiliar para actualizar estrella en lista
function actualizarEstrellaEnLista(id, esFavorita) {
  const listaElementos = document.querySelectorAll('#resultados .list-group-item');
  listaElementos.forEach(el => {
    if (parseInt(el.getAttribute('data-id')) === id) {
      const estrellaContainer = el.querySelector('div:last-child');
      if (estrellaContainer) {
        const badge = estrellaContainer.querySelector('.badge');
        const nuevaEstrella = esFavorita
          ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFD700" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.532.792c.197-.198.59-.198.787 0l2.252 4.369 4.898.696c.441.062.612.636.282.95l-3.523 3.356.83 4.73c.078.444-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
          : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16"><path d="M2.866 14.85c-.386.444.36.791.746.593l4.39-2.256 4.389 2.257c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.442.062-.612.636-.283.95l3.523 3.356-.83 4.73z"/></svg>';
        
        estrellaContainer.innerHTML = badge ? `${badge.outerHTML} ${nuevaEstrella}` : nuevaEstrella;
      }
    }
  });
}

// --- SISTEMA DE DEGUSTACIONES ---

// Cargar locales al abrir modal de degustaci√≥n - VERSI√ìN MEJORADA
function cargarLocales() {
    return fetch('/api/locales')
        .then(res => {
            if (!res.ok) {
                throw new Error(`Error ${res.status} al cargar locales`);
            }
            return res.json();
        })
        .then(data => {
            const select = document.getElementById('local_id');
            if (!select) {
                console.error("No se encontr√≥ el select de locales");
                return;
            }
            
            select.innerHTML = '<option value="">Seleccionar local...</option>';
            data.locales.forEach(local => {
                const option = document.createElement('option');
                option.value = local.id;
                option.textContent = `${local.nombre}${local.ciudad ? ` (${local.ciudad})` : ''}`;
                select.appendChild(option);
            });
            console.log("Locales cargados:", data.locales.length);
        })
        .catch(err => {
            console.error('Error cargando locales:', err);
            mostrarNotificacion('Error al cargar la lista de locales', 'error');
        });
}

// --- SISTEMA PARA A√ëADIR NUEVAS CERVEZAS ---

// Funci√≥n para abrir modal de nueva cerveza
function abrirModalNuevaCerveza(query) {
    const modalNuevaCerveza = new bootstrap.Modal(document.getElementById('modalNuevaCerveza'));
    
    // Prellenar el nombre con la b√∫squeda
    document.getElementById('nuevaCervezaNombre').value = query;
    
    // Cargar pa√≠ses si no est√°n cargados
    if (document.querySelector('#nuevaCervezaPais').options.length <= 1) {
        cargarPaises().then(paises => {
            llenarSelectPaises(paises);
        });
    }
    
    modalNuevaCerveza.show();
}

// Guardar nueva cerveza
function guardarNuevaCerveza() {
    const formData = new FormData(document.getElementById('formNuevaCerveza'));
    const data = {
        nombre: formData.get('nombre'),
        estilo: formData.get('estilo'),
        pais_procedencia: formData.get('pais_procedencia'),
        porcentaje_alcohol: formData.get('porcentaje_alcohol'),
        ibu: formData.get('ibu'),
        color: formData.get('color')
    };
    
    // Validaci√≥n b√°sica
    if (!data.nombre || !data.estilo || !data.pais_procedencia || !data.porcentaje_alcohol) {
        mostrarNotificacion('Por favor, completa todos los campos obligatorios', 'error');
        return;
    }
    
    // Agregar CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
    const headers = {
        'Content-Type': 'application/json',
    };
    
    if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
    }
    
    fetch('/api/cerveza/nueva', {
        method: 'POST',
        headers: headers,
        credentials: 'include',
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.status === 401) {
            mostrarNotificacion('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.', 'error');
            window.location.href = '/login';
            return;
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevaCerveza'));
            modal.hide();
            
            // Mostrar mensaje de √©xito
            mostrarNotificacion(result.message, 'success');
            
            // Limpiar formulario
            document.getElementById('formNuevaCerveza').reset();
            
            // Opcional: buscar autom√°ticamente la nueva cerveza
            setTimeout(() => {
                document.getElementById('buscador').value = data.nombre;
                document.getElementById('btnBuscar').click();
            }, 1000);
            
        } else {
            mostrarNotificacion('Error: ' + result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al guardar la cerveza', 'error');
    });
}

// --- CARGA INICIAL ACTUALIZADA ---
document.addEventListener('DOMContentLoaded', () => {
  // Cargar cervezas favoritas desde el backend para la secci√≥n de favoritas
  fetch('/mis_favoritas')
    .then(res => res.json())
    .then(data => {
      data.cervezas.forEach(c => cachearCerveza(c, 5.0)); // Asignar puntuaci√≥n de favorita
      actualizarSeccionFavoritas(); // Mostrar la secci√≥n si hay favoritas
    })
    .catch(err => {
      console.error('Error al cargar favoritas iniciales:', err);
      // Asegurar que la secci√≥n est√© oculta si falla
      document.getElementById('seccionFavoritas').classList.add('d-none');
    });

  const buscador = document.getElementById('buscador');
  const btnBuscar = document.getElementById('btnBuscar');

  // Funci√≥n para cargar sugerencias iniciales
  function cargarSugerenciasIniciales() {
    if (sugerenciasMostradas) return;
    fetch('/buscar_cervezas')
      .then(res => res.json())
      .then(data => {
        renderizarLista(data);
        sugerenciasMostradas = true;
      });
  }

  buscador.addEventListener('focus', cargarSugerenciasIniciales);
  buscador.addEventListener('input', () => {
    const q = buscador.value.trim();
    if (q === '') {
      cargarSugerenciasIniciales();
    } else {
      fetch(`/buscar_cervezas?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
          renderizarLista(data);
        });
    }
  });
  
  btnBuscar.addEventListener('click', () => {
    const q = buscador.value.trim();
    if (q) {
      fetch(`/buscar_cervezas?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
          renderizarLista(data);
        });
    } else {
      buscador.focus();
      cargarSugerenciasIniciales();
    }
  });
  
  buscador.addEventListener('blur', () => setTimeout(() => {
    const input = document.getElementById('buscador');
    if (input.value.trim() === '') {
      document.getElementById('resultados').innerHTML = '';
      sugerenciasMostradas = false;
    }
  }, 150));

  const modal = document.getElementById('modalCerveza');
  if (modal) {
    modal.addEventListener('show.bs.modal', function (event) {
      const b = event.relatedTarget;
      const id = parseInt(b.getAttribute('data-id'));
      document.getElementById('modalTitle').textContent = b.getAttribute('data-nombre');
      document.getElementById('modalEstilo').textContent = b.getAttribute('data-estilo');
      document.getElementById('modalPais').textContent = b.getAttribute('data-pais');
      document.getElementById('modalABV').textContent = b.getAttribute('data-abv');
      document.getElementById('modalIBU').textContent = b.getAttribute('data-ibu');
      document.getElementById('modalColor').textContent = b.getAttribute('data-color');
      actualizarBotonFavorita(id);
      
      // Guardar ID de cerveza actual para degustaci√≥n
      this.setAttribute('data-current-cerveza-id', id);
    });
  }

  // Configurar modal de degustaci√≥n
  const modalDegustacion = document.getElementById('modalDegustacion');
  if (modalDegustacion) {
    modalDegustacion.addEventListener('show.bs.modal', function() {
      // Cargar locales y pa√≠ses en paralelo
      cargarLocales();
      cargarPaises().then(paises => {
        llenarSelectPaises(paises);
      });
      
      // Configurar contador de comentario
      const comentario = document.getElementById('comentario');
      const contador = document.getElementById('contadorComentario');
      comentario.addEventListener('input', function() {
        contador.textContent = this.value.length;
      });
    });
  }
  
  // Bot√≥n registrar degustaci√≥n (en modal de cerveza)
  const btnRegistrarDegustacion = document.getElementById('btnRegistrarDegustacion');
  if (btnRegistrarDegustacion) {
    btnRegistrarDegustacion.onclick = function() {
      const modalCerveza = bootstrap.Modal.getInstance(document.getElementById('modalCerveza'));
      const modalDegustacion = new bootstrap.Modal(document.getElementById('modalDegustacion'));
      
      // Pasar datos de la cerveza al modal de degustaci√≥n
      const cervezaId = document.getElementById('modalCerveza').getAttribute('data-current-cerveza-id');
      const cervezaNombre = document.getElementById('modalTitle').textContent;
      const cervezaInfo = `${document.getElementById('modalEstilo').textContent} ¬∑ ${document.getElementById('modalPais').textContent}`;
      
      document.getElementById('degustacion_cerveza_id').value = cervezaId;
      document.getElementById('degustacion_cerveza_nombre').value = cervezaNombre;
      document.getElementById('degustacionCervezaNombre').textContent = cervezaNombre;
      document.getElementById('degustacionCervezaInfo').textContent = cervezaInfo;
      
      modalCerveza.hide();
      modalDegustacion.show();
    };
  }
  
  // Guardar degustaci√≥n
  const btnGuardarDegustacion = document.getElementById('btnGuardarDegustacion');
  if (btnGuardarDegustacion) {
    btnGuardarDegustacion.onclick = function() {
      const formData = new FormData(document.getElementById('formDegustacion'));
      const data = {
        cerveza_id: formData.get('cerveza_id'),
        puntuacion: formData.get('puntuacion'),
        comentario: formData.get('comentario'),
        tama√±o: formData.get('tama√±o'),
        formato: formData.get('formato'),
        local_id: formData.get('local_id') || null,
        pais_consumicion: formData.get('pais_consumicion')
      };
      
      // Validaci√≥n b√°sica
      if (!data.cerveza_id) {
        mostrarNotificacion('Error: No se especific√≥ la cerveza', 'error');
        return;
      }
      
      // Agregar CSRF token si est√° disponible
      const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
      const headers = {
        'Content-Type': 'application/json',
      };
      
      if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
      }
      
      fetch('/api/degustacion/nueva', {
        method: 'POST',
        headers: headers,
        credentials: 'include',
        body: JSON.stringify(data)
      })
      .then(response => {
        if (response.status === 401) {
          mostrarNotificacion('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.', 'error');
          window.location.href = '/login';
          return;
        }
        return response.json();
      })
      .then(result => {
        if (result.success) {
          // ‚úÖ Cerrar modal silenciosamente
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalDegustacion'));
          modal.hide();
          
          // Recargar para actualizar estad√≠sticas
          setTimeout(() => {
            location.reload();
          }, 500);
        } else {
          mostrarNotificacion('Error: ' + result.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al guardar la degustaci√≥n', 'error');
      });
    };
  }
  
  // Guardar nuevo local - VERSI√ìN CORREGIDA
  const btnGuardarLocal = document.getElementById('btnGuardarLocal');
  if (btnGuardarLocal) {
    btnGuardarLocal.onclick = function() {
      console.log("Intentando crear nuevo local...");
      
      // Obtener datos del formulario de forma directa
      const nombre = document.querySelector('#formNuevoLocal input[name="nombre"]').value.trim();
      const direccion = document.querySelector('#formNuevoLocal input[name="direccion"]').value.trim();
      const ciudad = document.querySelector('#formNuevoLocal input[name="ciudad"]').value.trim();
      const pais = document.querySelector('#formNuevoLocal select[name="pais"]').value;
      
      console.log("Datos del local:", { nombre, direccion, ciudad, pais });
      
      // Validaci√≥n b√°sica
      if (!nombre) {
        mostrarNotificacion('El nombre del local es obligatorio', 'error');
        return;
      }
      
      const data = {
        nombre: nombre,
        direccion: direccion,
        ciudad: ciudad,
        pais: pais
      };
      
      console.log("Enviando datos:", data);
      
      // Agregar CSRF token
      const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
      const headers = {
        'Content-Type': 'application/json',
      };
      
      if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
      }
      
      // Hacer la petici√≥n
      fetch('/api/local/nuevo', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(data)
      })
      .then(response => {
        console.log("Respuesta recibida, status:", response.status);
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
      })
      .then(result => {
        console.log("Resultado:", result);
        if (result.success) {
          mostrarNotificacion(result.message, 'success');
          
          // Cerrar modal de nuevo local
          const modalNuevoLocal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoLocal'));
          modalNuevoLocal.hide();
          
          // Recargar lista de locales
          cargarLocales().then(() => {
            if (result.local_id) {
              document.getElementById('local_id').value = result.local_id;
              console.log("Local seleccionado:", result.local_id);
            }
            
            // ‚úÖ VOLVER AL MODAL DE DEGUSTACI√ìN despu√©s de un breve delay
            setTimeout(() => {
              const modalDegustacion = new bootstrap.Modal(document.getElementById('modalDegustacion'));
              modalDegustacion.show();
            }, 400);
          });
          
        } else {
          mostrarNotificacion(result.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error en la petici√≥n:', error);
        mostrarNotificacion('Error de conexi√≥n: ' + error.message, 'error');
      });
    };
  }
  
  // Bot√≥n para abrir modal de nuevo local - VERSI√ìN MEJORADA
  const btnNuevoLocal = document.getElementById('btnNuevoLocal');
  if (btnNuevoLocal) {
    btnNuevoLocal.onclick = function(e) {
      e.preventDefault();
      console.log("Abriendo modal de nuevo local...");
      
      const modalDegustacion = bootstrap.Modal.getInstance(document.getElementById('modalDegustacion'));
      const modalNuevoLocal = new bootstrap.Modal(document.getElementById('modalNuevoLocal'));
      
      // Limpiar formulario antes de abrir
      const form = document.getElementById('formNuevoLocal');
      if (form) {
        form.reset();
      }
      
      if (modalDegustacion) {
        modalDegustacion.hide();
      }
      
      // Peque√±o delay para asegurar que se cierra el modal anterior
      setTimeout(() => {
        modalNuevoLocal.show();
      }, 300);
    };
  }

  // --- BOTONES DE CANCELAR MEJORADOS ---
  
  // Bot√≥n cancelar en modal de nuevo local - VERSI√ìN CORREGIDA
  const btnCancelarLocal = document.getElementById('btnCancelarLocal');
  if (btnCancelarLocal) {
      btnCancelarLocal.onclick = function() {
          console.log("Cancelando creaci√≥n de local...");
          const modalNuevoLocal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoLocal'));
          modalNuevoLocal.hide();
          
          // ‚úÖ VOLVER AL MODAL DE DEGUSTACI√ìN despu√©s de cancelar
          setTimeout(() => {
              const modalDegustacion = new bootstrap.Modal(document.getElementById('modalDegustacion'));
              modalDegustacion.show();
          }, 300);
      };
  }

  // Bot√≥n cerrar (X) en modal de nuevo local
  const btnCerrarLocal = document.getElementById('btnCerrarLocal');
  if (btnCerrarLocal) {
      btnCerrarLocal.onclick = function() {
          console.log("Cerrando modal de local...");
          const modalNuevoLocal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoLocal'));
          modalNuevoLocal.hide();
          
          // ‚úÖ VOLVER AL MODAL DE DEGUSTACI√ìN
          setTimeout(() => {
              const modalDegustacion = new bootstrap.Modal(document.getElementById('modalDegustacion'));
              modalDegustacion.show();
          }, 300);
      };
  }

  // Bot√≥n cancelar en modal de degustaci√≥n
  const btnCancelarDegustacion = document.getElementById('btnCancelarDegustacion');
  if (btnCancelarDegustacion) {
      btnCancelarDegustacion.onclick = function() {
          console.log("Cancelando degustaci√≥n...");
          const modalDegustacion = bootstrap.Modal.getInstance(document.getElementById('modalDegustacion'));
          modalDegustacion.hide();
      };
  }
  // Bot√≥n cerrar (X) en modal de degustaci√≥n
  const btnCerrarDegustacion = document.querySelector('#modalDegustacion .btn-close');
  if (btnCerrarDegustacion) {
      btnCerrarDegustacion.onclick = function() {
          console.log("Cerrando modal de degustaci√≥n...");
          const modalDegustacion = bootstrap.Modal.getInstance(document.getElementById('modalDegustacion'));
          modalDegustacion.hide();
      };
  }

  // --- SISTEMA DE NUEVAS CERVEZAS ---
  
  // Manejar clic en bot√≥n "A√±adir nueva cerveza" (usando delegaci√≥n de eventos)
  document.addEventListener('click', function(e) {
    if (e.target.id === 'btnAnadirCerveza' || e.target.closest('#btnAnadirCerveza')) {
      const button = e.target.id === 'btnAnadirCerveza' ? e.target : e.target.closest('#btnAnadirCerveza');
      const query = button.getAttribute('data-query');
      abrirModalNuevaCerveza(query);
    }
  });
  
  // Bot√≥n guardar nueva cerveza
  const btnGuardarNuevaCerveza = document.getElementById('btnGuardarNuevaCerveza');
  if (btnGuardarNuevaCerveza) {
    btnGuardarNuevaCerveza.onclick = guardarNuevaCerveza;
  }
  
  // Bot√≥n cancelar nueva cerveza
  const btnCancelarNuevaCerveza = document.getElementById('btnCancelarNuevaCerveza');
  if (btnCancelarNuevaCerveza) {
    btnCancelarNuevaCerveza.onclick = function() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevaCerveza'));
      modal.hide();
    };
  }
  
  // Bot√≥n cerrar (X) nueva cerveza
  const btnCerrarNuevaCerveza = document.getElementById('btnCerrarNuevaCerveza');
  if (btnCerrarNuevaCerveza) {
    btnCerrarNuevaCerveza.onclick = function() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevaCerveza'));
      modal.hide();
    };
  }
  // --- FIN CARGA INICIAL ---
});
// --- PA√çS DE CONSUMO CONDICIONAL ---

// Funci√≥n para manejar el cambio de local
function configurarPaisCondicional() {
    const localSelect = document.getElementById('local_id');
    const paisContainer = document.getElementById('paisConsumicionContainer');
    const paisSelect = document.getElementById('pais_consumicion');
    
    if (!localSelect || !paisContainer || !paisSelect) return;
    
    // Evento cuando cambia el local seleccionado
    localSelect.addEventListener('change', async function() {
        const localId = this.value;
        
        if (localId) {
            try {
                // Obtener informaci√≥n del local desde la API
                const response = await fetch(`/api/local/${localId}/info`);
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.local.pais) {
                        // El local tiene pa√≠s definido
                        // 1. Ocultar campo de pa√≠s
                        paisContainer.style.display = 'none';
                        
                        // 2. Seleccionar autom√°ticamente el pa√≠s del local
                        for (let option of paisSelect.options) {
                            if (option.value === data.local.pais) {
                                paisSelect.value = data.local.pais;
                                break;
                            }
                        }
                        
                        console.log(`üìç Pa√≠s autom√°tico: ${data.local.pais} (del local)`);
                    } else {
                        // El local no tiene pa√≠s definido
                        // 1. Mostrar campo de pa√≠s
                        paisContainer.style.display = 'block';
                        
                        // 2. Resetear selecci√≥n
                        paisSelect.value = '';
                        
                        console.log('‚ÑπÔ∏è Local sin pa√≠s definido, mostrando selector');
                    }
                }
            } catch (error) {
                console.error('Error al obtener info del local:', error);
                // Por defecto, mostrar el selector
                paisContainer.style.display = 'block';
                paisSelect.value = '';
            }
        } else {
            // No hay local seleccionado
            // 1. Mostrar campo de pa√≠s
            paisContainer.style.display = 'block';
            
            // 2. Resetear selecci√≥n
            paisSelect.value = '';
            
            console.log('‚ÑπÔ∏è No hay local seleccionado, mostrando selector de pa√≠s');
        }
    });
}

// Llamar a la funci√≥n cuando el modal se muestra
document.getElementById('modalDegustacion').addEventListener('show.bs.modal', function() {
    // Configurar el pa√≠s condicional
    configurarPaisCondicional();
    
    // Tambi√©n cargar pa√≠ses y locales
    cargarLocales();
    cargarPaises().then(paises => {
        llenarSelectPaises(paises);
    });
});

// --- FIN PA√çS CONDICIONAL ---
</script>

<style>
  /* Estilos para la secci√≥n de favoritas */
#listaFavoritas, #favoritasTodas {
  list-style: none !important; /* Elimina puntos de lista */
  padding-left: 0 !important;  /* Elimina sangr√≠a */
  margin-bottom: 0 !important; /* Sin margen extra */
}

.favorita-item {
  list-style: none !important;
  margin-bottom: 0.5rem;
}

.favorita-item:last-child {
  margin-bottom: 0;
}

#seccionFavoritas .card-body {
  padding-bottom: 0.5rem; /* Menos padding abajo */
}

#btnVerTodasFavoritas {
  margin-top: 0.5rem; /* Separaci√≥n del contenido */
}

/* Transici√≥n suave para expandir/contraer */
#favoritasTodas {
  transition: all 0.3s ease;
  max-height: 500px; /* L√≠mite m√°ximo */
  overflow: hidden;
}

.text-beersp {
  color: #d4a017;
}
.bg-beersp {
  background-color: #d4a017 !important;
  border-color: #b8860b !important;
}
.btn-outline-beersp {
  color: #d4a017;
  border-color: #d4a017;
}
.btn-outline-beersp:hover {
  background-color: #d4a017;
  border-color: #d4a017;
  color: white;
}
.nav-pills .nav-link.active {
  background-color: #d4a017;
  border-color: #b8860b;
}
.card {
  border: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.card-title {
  color: #8b4513;
}
</style>
{% endblock %}